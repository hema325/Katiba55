<div class="d-flex justify-content-between align-items-center flex-wrap gap-4 mb-4">
  <h6 class="text-secondary mb-0">
    <i class="fa-solid fa-sack-dollar text-primary me-2"></i>
    الموقف المالي
  </h6>
  <div class="d-flex justify-content-end align-items-center gap-2 flex-fill">
    <input type="text" class="form-control w-auto flex-fill" placeholder="بحث..." [(ngModel)]="searchText"
      (ngModelChange)="onSearchChange()" style="max-width: 300px;" />
    <button class="btn btn-outline-primary" type="button">
      <i class="fa-solid fa-print"></i> طباعة
    </button>
  </div>
</div>

@if(isLoading)
{
<div class="w-100 d-flex justify-content-center align-items-center py-5">
  <c-spinner color="primary" />
</div>
}
@else if(works.length == 0) {
<div class="alert alert-info">
  <i class="fa-solid fa-info-circle me-2"></i>لا يوجد موقف مالى لعرضة.
</div>
}
@else {
<div class="overflow-auto mb-5">
  <table class="table table-bordered align-middle text-center shadow-sm rounded-4 overflow-hidden">
    <thead class="table-secondary">
      <tr>
        <th rowSpan="2">اسم العمل</th>
        <th colspan="5">المقايسة</th>
        <th colspan="3">العقد</th>
        <th colspan="4">المستخلص</th>
      </tr>
      <tr>
        <th>الشركة المسؤلة</th>
        <th>رقم المقايسة</th>
        <th>عنوان المقايسة</th>
        <th>قيمة المقايسة</th>
        <th>موقف المقايسة</th>
        <th>رقم العقد</th>
        <th>قيمة العقد</th>
        <th>موقف العقد</th>
        <th>نوع المستخلص</th>
        <th>قيمة المستخلص</th>
        <th>موقف المستخلص</th>
        <th>مكان المستخلص</th>
      </tr>
    </thead>
    <tbody>
      @for(work of filteredWorks; track work.id) {
      @if(!work.boQs || work.boQs.length === 0) {
      <tr>
        <td>{{ work.name }}</td>
        <td colspan="12"></td>
      </tr>
      }
      @else {
      @for(boq of work.boQs; track boq.id; let firstBoq = $first) {
      @if(!boq.contract || !boq.contract.invoices || boq.contract.invoices.length === 0) {
      <tr>
        @if(firstBoq) {
        <td [rowSpan]="getWorkRowSpan(work)">{{ work.name }}</td>
        }
        <td>{{ boq.company?.name || '-' }}</td>
        <td>{{ boq.number }}</td>
        <td>{{ boq.title }}</td>
        <td>{{ (boq.value | number) || '-' }}</td>
        <td>{{ boq.status }}</td>
        <td>{{ boq.contract?.number || '-' }}</td>
        <td>{{ (boq.contract?.value | number) || '-' }}</td>
        <td>{{ boq.contract?.status || '-' }}</td>
        <td colspan="4">-</td>
      </tr>
      }
      @else {
      @for(invoice of boq.contract.invoices; track invoice.id; let firstInvoice = $first) {
      <tr>
        @if(firstBoq && firstInvoice) {
        <td [rowSpan]="getWorkRowSpan(work)">{{ work.name }}</td>
        }
        @if(firstInvoice) {
        <td [rowSpan]="boq.contract.invoices.length">{{ boq.company?.name || '-' }}</td>
        <td [rowSpan]="boq.contract.invoices.length">{{ boq.number }}</td>
        <td [rowSpan]="boq.contract.invoices.length">{{ boq.title }}</td>
        <td [rowSpan]="boq.contract.invoices.length">{{ boq.value | number }}</td>
        <td [rowSpan]="boq.contract.invoices.length">{{ boq.status }}</td>
        <td [rowSpan]="boq.contract.invoices.length">{{ boq.contract.number }}</td>
        <td [rowSpan]="boq.contract.invoices.length">{{ boq.contract.value | number }}</td>
        <td [rowSpan]="boq.contract.invoices.length">{{ boq.contract.status }}</td>
        }
        <td>{{ invoice.type }}</td>
        <td>{{ invoice.value | number }}</td>
        <td>{{ invoice.status }}</td>
        <td>{{ invoice.location || '-' }}</td>
      </tr>
      }
      }
      }
      }
      }
    </tbody>
    <tfoot>
      <tr class="table-primary fw-bold">
        <td colspan="4">الإجمالي</td>
        <td>{{ totalBoqValue | number }}</td>
        <td></td>
        <td></td>
        <td>{{ totalContractValue | number }}</td>
        <td></td>
        <td></td>
        <td>{{ totalInvoicesValue | number }}</td>
        <td colspan="2"></td>
      </tr>
    </tfoot>
  </table>
</div>
}